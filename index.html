<html>

<head>
  <title>DBD</title>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/102/three.js"></script>
</head>
<style>
  * {
    margin: 0;
    padding: 0;
    outline: 0;
  }

  html,
  body {
    width: 100%;
    background-color: rgba(64, 64, 64, 1);
  }

  .hcenter {
    position: absolute;
    margin: 0;
    left: 50%;
    transform: translateX(-50%);
  }
</style>
<body>
  <div>
    <div id="main" class="hcenter" style="width: 1200px;">

    </div>
  </div>
  <div id="canvasWrap">
  </div>
</body>
<script type="text/javascript">
var language = localStorage.getItem("language") || "zh-Hans";
localStorage.setItem("language", language);

function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
    }
    return array;
}

function perkOnClick(key) {
    fetch(`https://www.sgkoishi.app/dbddata/${key}/owner.json`).then(r => {
        return r.json();
    }).then(r => {
        localStorage.setItem(key + ".owner", r.owner);
        var ownerCode = r.owner;
        fetch(`https://www.sgkoishi.app/dbddata/${r.owner}/data.json`).then(r => {
            return r.json();
        }).then(r => {
            localStorage.setItem(ownerCode, JSON.stringify(r));
            updateCanvas(key);
        });
    });
    fetch(`https://www.sgkoishi.app/dbddata/${key}/rarity.json`).then(r => {
        return r.json();
    }).then(r => {
        localStorage.setItem(key + ".rarity", JSON.stringify(r));
        updateCanvas(key);
    });
    fetch(`https://www.sgkoishi.app/dbddata/${key}/data.json`).then(r => {
        return r.json();
    }).then(r => {
        // e.target.parentNode.classList.remove("unrevealed");
        // e.target.parentNode.children[1].style.backgroundImage = `url(https://www.sgkoishi.app/dbddata/${key}/icon.png)`;
        localStorage.setItem(key, JSON.stringify(r));
        updateCanvas(key);
    }, (r) => {
        console.log(r);
    });
}

function perkOnEnter(e) {
    updateCanvas(e.target.dataset.perk);
}

function updateCanvas(perkCode) {
    var item = localStorage.getItem(perkCode)
    var owner = perkCode + ".owner";
    var ownerCode = localStorage.getItem(owner);
    var rarity = localStorage.getItem(perkCode + ".rarity");
    if (!item) {
        ownerCode = "unrevealed.owner";
        item = localStorage.getItem("unrevealed");
        rarity = [0, 0, 0];
    } else {
        rarity = JSON.parse(rarity);
    }
    canvasTitle.innerHTML = JSON.parse(item)[language];
    bgColor = JSON.parse(localStorage.getItem("raritycolor"))[rarity[1]];
    var ownerData = localStorage.getItem(ownerCode);
    var ownerText = "";
    if (ownerData) {
        canvasDesc.innerHTML = `${(JSON.parse(localStorage.getItem("rarity"))[rarity[1]])} - ${JSON.parse(localStorage.getItem(ownerCode))[language]} - 技能`;
    } else {
        canvasDesc.innerHTML = `${(JSON.parse(localStorage.getItem("rarity"))[rarity[1]])} - 技能`;
    }
}
var list = ["unrevealed", "unrevealed.owner", "rarity", "raritycolor"];
list.forEach(element => {
    fetch(`https://www.sgkoishi.app/dbddata/static/${element}.json`).then(r => r.json()).then(r => {
        localStorage.setItem(element, JSON.stringify(r));
    })
});

function randomArray(min, max, length, isint) {
    return isint ? Array.from({
            length: length
        }, () => Math.floor(Math.random() * (max - min) + min)) :
        Array.from({
            length: length
        }, () => Math.random() * (max - min) + min);
}
var expWidth = 1200;
var expHeight = 1000;
var scene = new THREE.Scene();
var camera = new THREE.OrthographicCamera(0, 10, 0, 10, -5, 5);
var camera2 = new THREE.OrthographicCamera(10, 20, 1.5, -1.5, -2, 2);
var renderer = new THREE.WebGLRenderer({
    antialias: true,
    alpha: true
});
renderer.setClearColor("rgb(255, 0, 0)", 0);
renderer.setSize(expWidth, expHeight);
document.getElementById("main").appendChild(renderer.domElement);
var mouse = new THREE.Vector2(-100, -100);
var floating = new THREE.Vector2(-600, -600);
var mouseDown = false;
var pureMouse = new THREE.Vector2(-100, -100);
var loader = new THREE.TextureLoader();
var materialPerk = new THREE.MeshLambertMaterial({
    map: loader.load("https://www.sgkoishi.app/dbddata/static/perks.png"),
    transparent: true,
    side: THREE.DoubleSide,
    depthWrite: false,
    depthTest: false
});
var geometry = new THREE.PlaneGeometry(1, 1);
var blackBg = new THREE.Mesh(geometry);
blackBg.material.color.set(0);
blackBg.position.set(15, 0, 0);
blackBg.scale.set(10, 3, 1);
scene.add(blackBg);
var materialSmoke = new THREE.MeshLambertMaterial({
    map: loader.load("https://www.sgkoishi.app/dbd/smoke.png"),
    transparent: true,
    depthWrite: false,
    depthTest: false
});
materialSmoke.color.set("rgb(90, 40, 110)");
var meshSmokes = [];
for (var i = 0; i < 60; i++) {
    var meshSmoke = new THREE.Mesh(geometry, materialSmoke.clone());
    meshSmoke.userVX = (Math.random() * 8 + 2) / 360;
    meshSmoke.userBX = (Math.random() * 5) + 16;
    meshSmoke.userY = Math.random() * 3 - 1.5;
    meshSmoke.userRS = ((Math.random() * 2 - 1) * Math.PI) / 360;
    meshSmoke.position.set(Math.random() * 4 + 10, meshSmoke.userY, 0);
    meshSmoke.scale.set(4, 4, 4);
    meshSmokes.push(meshSmoke);
    scene.add(meshSmoke);
}
var bitmap = document.createElement('canvas');
var g = bitmap.getContext('2d');
var floatingTitle = "把最好的留到最后";
bitmap.width = 84 * 9;
bitmap.height = 84;
g.font = 'Bold 72px Arial';
g.fillStyle = 'white';
g.fillText(floatingTitle, 0, 70);
var texture = new THREE.Texture(bitmap)
texture.needsUpdate = true;
var textBg = new THREE.Mesh(geometry, new THREE.MeshLambertMaterial({
    map: texture,
    transparent: true
}));
//blackBg.material.color.set(0);
textBg.position.set(15, 0, 0);
textBg.scale.set(9, 99 ** 99 == Math.pow(99, 99) ? 1 : -1, 1);
scene.add(textBg);
// https://www.sgkoishi.app/img/koishi.png
// https://www.sgkoishi.app/dbddata/static/perks.png
// https://www.sgkoishi.app/dbd/smoke.png

var meshPerks = [];
fetch("https://www.sgkoishi.app/dbddata/static/killerperks.json").then(r => r.json()).then(r => {
    var perksShuffled = shuffleArray(r);
	for (var i = 0; i < perksShuffled.length; i++)
	{
    var meshPerk = new THREE.Mesh(geometry, materialPerk);
    meshPerk.position.set(0.5 + i % 10, 2.5 + parseInt(i / 10), 0);
    meshPerk.rotation.y = Math.PI;
    meshPerk.scale.y = -1;
	meshPerk.userPerkCode = perksShuffled[i];
    meshPerks.push(meshPerk);
    scene.add(meshPerk);
	}
});
var light = new THREE.AmbientLight(0xffffff); // soft white light
scene.add(light);
var now = Date.now();

function animate() {
    requestAnimationFrame(animate);
    for (var i = 0; i < meshPerks.length; i++) {
        let meshPerk = meshPerks[i];
        if (meshPerk.shouldRotate) {
            if (meshPerk.rotation.y < Math.PI * 1.5) {
                meshPerk.rotation.y += Math.PI / 120;
            } else
            if (!meshPerk.userDataInit) {
                meshPerk.material = meshPerk.material.clone();
                meshPerk.material.color.set(0x5A413E);
                meshPerk.userDataInit = true;
            } else if (meshPerk.rotation.y < Math.PI * 2) {
                meshPerk.rotation.y += Math.PI / 120;
            }
        }
    }
    for (var i = 0; i < meshSmokes.length; i++) {
        meshSmokes[i].position.x += meshSmokes[i].userVX;
        if (meshSmokes[i].position.x > meshSmokes[i].userBX) {
            meshSmokes[i].position.x = 8;
			meshSmokes[i].material.opacity = 1;
        } else {
            //meshSmokes[i].material.opacity = 1 - (meshSmokes[i].position.x - 9) / (meshSmokes[i].userBX - 8);
        }
        meshSmokes[i].rotation.z += meshSmokes[i].userRS;
    }
    renderer.setViewport(0, 0, expWidth, expWidth);
    renderer.setScissor(0, 0, expWidth, expHeight);
    renderer.setScissorTest(true);
    renderer.render(scene, camera);
    renderer.autoClear = false;
    renderer.setViewport(floating.x, floating.y, 500, 150);
    renderer.setScissor(floating.x, floating.y, 500, 150);
    renderer.setScissorTest(true);
    renderer.render(scene, camera2);
    renderer.autoClear = true;
    renderer.setClearColor("rgb(64, 64, 64)", 1);
}

function updateMouse() {
    var pageScrollX = window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft || 0;
    var pageScrollY = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    mouse.x = ((pureMouse.x - document.getElementById("main").getBoundingClientRect().x - pageScrollX) / Math.min(expWidth, window.innerWidth)) * 2 - 1;
    mouse.y = -((pureMouse.y - document.getElementById("main").getBoundingClientRect().y + pageScrollY) / Math.min(expHeight, window.innerHeight)) * 2 + 1;
    floating.x = pureMouse.x - document.getElementById("main").getBoundingClientRect().x;
	if (floating.x < 0) floating.x = 0;
	else if (floating.x > expWidth) floating.x = 700;
	else if (floating.x + 500 > expWidth) floating.x -= 500;
    floating.y = expHeight - pureMouse.y + document.getElementById("main").getBoundingClientRect().y - 150;
	if (floating.y < 0) floating.y += 150;
}
window.addEventListener('mousemove', (event) => {
    pureMouse.x = event.clientX
    pureMouse.y = event.clientY;
    updateMouse();
}, false);
window.addEventListener('scroll', updateMouse, false);
window.addEventListener("mousedown", () => mouseDown = true);
window.addEventListener("mouseup", () => mouseDown = false);
animate();
</script>

</html>